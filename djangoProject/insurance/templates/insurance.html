{% extends "baseTemplate.html" %}
{% load static %}
{% block page_css %}
    <link rel="stylesheet" href="{% static 'css/insuranceForm.css' %}">
{% endblock %}

{% block content %}
<h1>Patient's Insurance Billing</h1>
<!-- Patient Search Form -->
<div class="flex-container">
    <div class="add_background">
        <form id="search-form">
            <div class="form-group">
                <h2>Search for patient</h2>
                <select id="patient-dropdown" onchange="searchPatient()">
                    <option value="" selected disabled>Select a patient</option>
                </select>       
            </div>
        </form>
        
        <!-- Simulated Patient Details, shown after search -->
        <div id="patient-details" style="display: none;">
            <h2>Patient Details</h2>
            <table class="details-table">
                <tbody>
                    <tr>
                        <td><strong>Patient Name</strong></td>
                        <td id="patient-name"></td>
                    </tr>
                    <tr>
                        <td><strong>Date of Birth</strong></td>
                        <td id="patient-dob"></td>
                    </tr>
                    <tr>
                        <td><strong>Insurance Number</strong></td>
                        <td id="insurance-number"></td>
                    </tr>
                    <tr>
                        <td><strong>Carrier Name</strong></td>
                        <td id="carrier-name"></td>
                    </tr>
                </tbody>
            </table>

            <h3>Billing Information</h3>
            <table class="details-table" id="billing-table">
                <tbody>
                    <!-- Billing data will be populated dynamically -->
                </tbody>
            </table>
        </div>
    </div>
</div>

<script>
    document.addEventListener("DOMContentLoaded", function() {
        // Parse the JSON data passed from Django
        const patientsWithBilling = JSON.parse('{{ patients_json|escapejs }}');
        const dropdown = document.getElementById("patient-dropdown");

        // Populate dropdown options dynamically
        patientsWithBilling.forEach(function(data) {
            const option = document.createElement("option");
            option.value = data.id;
            option.textContent = `${data.first_name} ${data.last_name}`;
            dropdown.appendChild(option);
        });
    });

    function searchPatient() {
        const dropdown = document.getElementById("patient-dropdown");
        const selectedPatientId = dropdown.value;

        // Find the selected patient's data
        const patientData = JSON.parse('{{ patients_json|escapejs }}').find(function(data) {
            return data.id == selectedPatientId;
        });

        if (patientData) {
            document.getElementById("patient-details").style.display = "block";
            // Display patient details
            document.getElementById("patient-name").textContent = `${patientData.first_name} ${patientData.last_name}`;
            document.getElementById("patient-dob").textContent = patientData.dob;  // Assuming dob is a field
            document.getElementById("insurance-number").textContent = patientData.insurance_number;
            document.getElementById("carrier-name").textContent = patientData.carrier_name;

            // Display billing information
            const billingTable = document.getElementById("billing-table");
            billingTable.innerHTML = "";  // Clear previous billing entries
            patientData.billings.forEach(function(billing) {
                const rowInvoiceNumber = document.createElement("tr");
                rowInvoiceNumber.innerHTML = `
                    <td><strong>Invoice Number</strong></td>
                    <td>${billing.invoice_number}</td>
                `;
                billingTable.appendChild(rowInvoiceNumber);

                const rowInvoiceDate = document.createElement("tr");
                rowInvoiceDate.innerHTML = `
                    <td><strong>Invoice Date</strong></td>
                    <td>${billing.invoice_date}</td>
                `;
                billingTable.appendChild(rowInvoiceDate);

                const rowServiceDescription = document.createElement("tr");
                rowServiceDescription.innerHTML = `
                    <td><strong>Service Description</strong></td>
                    <td>${billing.service_description}</td>
                `;
                billingTable.appendChild(rowServiceDescription);

                const rowTotalBilled = document.createElement("tr");
                rowTotalBilled.innerHTML = `
                    <td><strong>Total Billed</strong></td>
                    <td>${billing.total_billed}</td>
                `;
                billingTable.appendChild(rowTotalBilled);
            });
        } else {
            alert("Patient not found.");
        }
    }
</script>

{% endblock %}
